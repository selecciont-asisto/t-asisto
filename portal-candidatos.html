<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (sessionStorage.getItem('selectionAuth') !== 'true') {
            window.location.href = 'login-seleccionados.html';
            return;
        }
        document.getElementById('logoutButton').addEventListener('click', () => {
            sessionStorage.removeItem('selectionAuth');
            window.location.href = 'login-seleccionados.html';
        });
        fetchCandidates();
    });

    async function fetchCandidates() {
        const loadingDiv = document.getElementById('loading');
        const listDiv = document.getElementById('candidateList');
        const noCandidatesDiv = document.getElementById('noCandidates');
        try {
            const response = await fetch('/api/get-seleccionados');
            if (!response.ok) throw new Error('Error del servidor.');
            const candidates = await response.json();
            loadingDiv.classList.add('hidden');

            if (candidates.length === 0) {
                noCandidatesDiv.classList.remove('hidden');
            } else {
                let html = '<div class="divide-y divide-gray-200">';
                candidates.forEach(candidate => {
                    // Si submissionTimestamp es 0, muestra 'Desconocida'
                    const submissionDate = candidate.submissionTimestamp
                      ? new Date(candidate.submissionTimestamp).toLocaleDateString('es-CO')
                      : 'Desconocida';
                    const psychometricEval = candidate.psychometricTest ? candidate.psychometricTest.evaluation : 'Pendiente';
                    let evalColor = 'text-gray-500';
                    if (psychometricEval === 'Apto') evalColor = 'text-green-600';
                    if (psychometricEval === 'Apto con reservas') evalColor = 'text-yellow-600';
                    if (psychometricEval === 'No apto') evalColor = 'text-red-600';
                    html += `
                        <div class="candidate-item p-4 flex justify-between items-center transition-colors">
                            <a href="#" class="flex-grow">
                                <div>
                                    <p class="font-bold text-lg text-indigo-700">${candidate.fullName}</p>
                                    <p class="text-sm text-gray-600">${candidate.email}</p>
                                    <p class="text-xs text-gray-400 mt-1">Enviado: ${submissionDate}</p>
                                </div>
                            </a>
                            <div class="text-right">
                                <p class="font-semibold ${evalColor}">${psychometricEval}</p>
                                <p class="text-sm text-gray-500">Puntaje: ${candidate.psychometricTest ? candidate.psychometricTest.score : 'N/A'}</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listDiv.innerHTML = html;
                listDiv.classList.remove('hidden');
            }
        } catch (error) {
            console.error(error);
            loadingDiv.textContent = 'Error al cargar los candidatos.';
        }
    }
</script>
