<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Caracterización - T-Asisto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para el spinner de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
        
        <div class="flex justify-center mb-6">
            <img src="Logoprincipal.jpg" alt="Logo T-Asisto" class="h-16 w-auto">
        </div>

        <h1 class="text-3xl font-bold text-center text-gray-800">Formulario de Caracterización</h1>
        <p class="text-center text-gray-500 mb-8">Completa tu información para iniciar el proceso de selección.</p>

        <form id="characterizationForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
            
            <!-- Fecha de Diligenciamiento -->
            <div class="md:col-span-2">
                <label for="submissionDate" class="block text-sm font-medium text-gray-700">Fecha de Diligenciamiento</label>
                <input type="text" id="submissionDate" name="submissionDate" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" readonly>
            </div>

            <!-- Ubicación Geográfica -->
            <div>
                <label for="country" class="block text-sm font-medium text-gray-700">País</label>
                <select id="country" name="country" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    <option value="">Selecciona un país...</option>
                </select>
            </div>
             <div>
                <label for="city" class="block text-sm font-medium text-gray-700">Ciudad</label>
                <select id="city" name="city" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required disabled>
                    <option value="">Selecciona una ciudad...</option>
                </select>
            </div>
            <div id="department-container" class="hidden">
                <label for="department" class="block text-sm font-medium text-gray-700">Departamento</label>
                <select id="department" name="department" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    <option value="">Selecciona un departamento...</option>
                </select>
            </div>
           
            <!-- Información de Contacto -->
            <div>
                <label for="fullName" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                <input type="text" id="fullName" name="fullName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                <input type="email" id="email" name="email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
            </div>
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                <input type="tel" id="phone" name="phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
            </div>
            <div>
                <label for="idNumber" class="block text-sm font-medium text-gray-700">Documento de Identidad</label>
                <input type="text" id="idNumber" name="idNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
            </div>
            <div>
                <label for="birthDate" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                <input type="date" id="birthDate" name="birthDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
            </div>
            <div>
                <label for="age" class="block text-sm font-medium text-gray-700">Edad</label>
                <input type="text" id="age" name="age" class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" readonly>
            </div>

            <!-- Educación y Experiencia -->
             <div class="md:col-span-2">
                <label for="educationLevel" class="block text-sm font-medium text-gray-700">Nivel de Estudios</label>
                <select id="educationLevel" name="educationLevel" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    <option value="">Selecciona una opción...</option>
                    <option value="Bachiller">Bachiller</option>
                    <option value="Técnico">Técnico</option>
                    <option value="Tecnólogo">Tecnólogo</option>
                    <option value="Profesional">Profesional</option>
                    <option value="Posgrado">Posgrado</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">¿Tienes experiencia previa en el cuidado o acompañamiento de adultos mayores?</label>
                <div class="mt-2 flex space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="hasExperience" value="Sí" class="text-indigo-600 focus:ring-indigo-500" required>
                        <span class="ml-2">Sí</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="hasExperience" value="No" class="text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2">No</span>
                    </label>
                </div>
            </div>
            <div id="experience-description-container" class="md:col-span-2 hidden">
                <label for="experienceDescription" class="block text-sm font-medium text-gray-700">Describe tu experiencia con adultos mayores</label>
                <textarea id="experienceDescription" name="experienceDescription" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
            </div>
            
            <!-- Disponibilidad -->
            <div>
                <label for="dedicationTime" class="block text-sm font-medium text-gray-700">Tiempo de dedicación</label>
                <select id="dedicationTime" name="dedicationTime" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    <option value="">Selecciona una opción...</option>
                    <option value="2-4 horas al día">2 a 4 horas al día</option>
                    <option value="4-6 horas al día">4 a 6 horas al día</option>
                    <option value="8 horas al día">8 horas al día</option>
                </select>
            </div>
            <div>
                <label for="availableDays" class="block text-sm font-medium text-gray-700">Días disponibles</label>
                <select id="availableDays" name="availableDays" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    <option value="">Selecciona una opción...</option>
                    <option value="1 día a la semana">1 día a la semana</option>
                    <option value="2 días a la semana">2 días a la semana</option>
                    <option value="3 días a la semana">3 días a la semana</option>
                    <option value="4 días a la semana">4 días a la semana</option>
                    <option value="5 días a la semana">5 días a la semana</option>
                    <option value="Solo fines de semana">Solo fines de semana</option>
                </select>
            </div>
            
            <!-- Botón de Envío -->
            <div class="md:col-span-2 flex justify-end items-center">
                 <div id="loader" class="loader hidden mr-4"></div>
                <button type="submit" id="submitButton" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300">
                    Continuar
                </button>
            </div>
        </form>
        
        <div id="ageWarning" class="hidden mt-6 text-center p-4 rounded-lg bg-red-100 border border-red-400 text-red-700">
            <p class="font-bold">No cumples con la edad mínima requerida.</p>
            <p>Para postularte a T-Asisto, debes ser mayor de 18 años. Agradecemos tu interés.</p>
        </div>

        <div id="successMessage" class="hidden mt-6 text-center p-4 rounded-lg bg-green-100 border border-green-400 text-green-700">
            <p class="font-bold">¡Información guardada con éxito!</p>
            <p>Serás redirigido a la prueba psicométrica en unos segundos...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                     if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid;
                }
                console.log("Usuario autenticado. UID:", userId);
            });
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
        }

        const form = document.getElementById('characterizationForm');
        const submissionDateInput = document.getElementById('submissionDate');
        const birthDateInput = document.getElementById('birthDate');
        const ageInput = document.getElementById('age');
        const ageWarning = document.getElementById('ageWarning');
        const successMessage = document.getElementById('successMessage');
        const submitButton = document.getElementById('submitButton');
        const loader = document.getElementById('loader');

        const countrySelect = document.getElementById('country');
        const departmentContainer = document.getElementById('department-container');
        const departmentSelect = document.getElementById('department');
        const citySelect = document.getElementById('city');

        let geoData = {};

        async function loadGeoData() {
            try {
                const response = await fetch('./geodata.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                geoData = await response.json();
                populateCountries();
            } catch (error) {
                console.error("No se pudo cargar la información geográfica:", error);
                alert("Error al cargar datos de ubicación. Por favor, refresca la página.");
            }
        }

        function populateCountries() {
            Object.keys(geoData.paises).forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }
        
        countrySelect.addEventListener('change', () => {
            const selectedCountry = countrySelect.value;
            departmentSelect.innerHTML = '<option value="">Selecciona un departamento...</option>';
            citySelect.innerHTML = '<option value="">Selecciona una ciudad...</option>';
            citySelect.disabled = true;

            if (selectedCountry === "Colombia") {
                departmentContainer.classList.remove('hidden');
                departmentSelect.required = true;
                const departments = geoData.paises[selectedCountry].departamentos;
                Object.keys(departments).sort().forEach(dep => {
                     const option = document.createElement('option');
                     option.value = dep;
                     option.textContent = dep;
                     departmentSelect.appendChild(option);
                });
            } else {
                departmentContainer.classList.add('hidden');
                departmentSelect.required = false;
                 if(selectedCountry && geoData.paises[selectedCountry].ciudades) {
                    populateCitiesDirectly(selectedCountry);
                }
            }
        });

        departmentSelect.addEventListener('change', () => {
            const selectedDepartment = departmentSelect.value;
            citySelect.innerHTML = '<option value="">Selecciona una ciudad...</option>';
            citySelect.disabled = true;

            if (selectedDepartment) {
                const cities = geoData.paises.Colombia.departamentos[selectedDepartment];
                if (cities) {
                    cities.sort().forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                    citySelect.disabled = false;
                }
            }
        });

        function populateCitiesDirectly(country) {
            const cities = geoData.paises[country].ciudades;
            if(cities) {
                cities.sort().forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
                citySelect.disabled = false;
            }
        }
        
        document.querySelectorAll('input[name="hasExperience"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const descriptionContainer = document.getElementById('experience-description-container');
                const descriptionTextarea = document.getElementById('experienceDescription');
                if (e.target.value === 'Sí') {
                    descriptionContainer.classList.remove('hidden');
                    descriptionTextarea.required = true;
                } else {
                    descriptionContainer.classList.add('hidden');
                    descriptionTextarea.required = false;
                    descriptionTextarea.value = '';
                }
            });
        });

        function setSubmissionDate() {
            const today = new Date();
            submissionDateInput.value = today.toLocaleDateString('es-CO');
        }

        function calculateAge() {
            const birthDate = new Date(birthDateInput.value);
            if (!isNaN(birthDate.getTime())) {
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                ageInput.value = age;
                
                if (age < 18) {
                    ageWarning.classList.remove('hidden');
                    form.classList.add('hidden');
                } else {
                    ageWarning.classList.add('hidden');
                    form.classList.remove('hidden');
                }
            } else {
                ageInput.value = "";
            }
        }
        
        birthDateInput.addEventListener('change', calculateAge);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            loader.classList.remove('hidden');

            if (!userId) {
                console.error("No hay un usuario autenticado para guardar los datos.");
                alert("Error de autenticación. Por favor, recargue la página e inténtelo de nuevo.");
                submitButton.disabled = false;
                loader.classList.add('hidden');
                return;
            }

            const formData = new FormData(form);
            const candidateData = Object.fromEntries(formData.entries());
            candidateData.submissionTimestamp = new Date();

            console.log("Guardando datos del candidato:", candidateData);
            
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/candidatos`;
                await addDoc(collection(db, collectionPath), candidateData);
                
                form.classList.add('hidden');
                successMessage.classList.remove('hidden');

                setTimeout(() => {
                    window.location.href = 'test.html';
                }, 3000);

            } catch (error) {
                console.error("Error al añadir el documento: ", error);
                alert("Hubo un error al guardar tu información. Por favor, inténtalo de nuevo.");
                submitButton.disabled = false;
                loader.classList.add('hidden');
            }
        });

        // Initialize
        setSubmissionDate();
        loadGeoData();
    </script>
</body>
</html>


