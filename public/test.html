<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Psicométrica - T-Asisto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .question-card {
            border-left: 4px solid #4f46e5; /* Indigo color */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
        <div id="testContainer">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Prueba Psicométrica</h1>
            <p class="text-center text-gray-500 mb-8">Responda a cada pregunta eligiendo la opción que mejor se ajuste a su manera de ser o actuar en la situación descrita.</p>

            <form id="psychometricTestForm" class="space-y-8">
                <!-- Las preguntas se cargarán aquí desde el JSON -->
            </form>
        </div>

        <div id="resultContainer" class="hidden text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Prueba Finalizada</h2>
            <p id="finalMessage" class="p-4 rounded-lg"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACIÓN DE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;

        const testData = {
            "preguntas": [{ "id": 1, "pregunta": "¿Cuál de estas frases describe mejor tu motivación para ayudar a los demás?", "opciones": [{ "respuesta": "Me siento feliz y realizado cuando mi ayuda es valiosa y viene de un lugar donde yo también me siento bien.", "puntuacion": 1 }, { "respuesta": "Ayudar a los demás es mi deber, incluso si a veces me agota o me quita tiempo para mí.", "puntuacion": -1 }, { "respuesta": "Ayudo esperando que luego las personas me retribuyan el favor de alguna manera.", "puntuacion": -1 }, { "respuesta": "Ayudo solo si la tarea es sencilla y no me implica mucho esfuerzo.", "puntuacion": -1 }] }, { "id": 2, "pregunta": "Un adulto mayor te dice: 'Me siento muy torpe, se me cae todo de las manos. ¡Es inútil intentar hacer esto!'. ¿Qué le responderías?", "opciones": [{ "respuesta": "Le dirías: 'No se preocupe, es normal sentirse así a su edad, no es su culpa'.", "puntuacion": -1 }, { "respuesta": "Le animarías: 'No es tan complicado, con un poco de práctica lo logrará fácilmente'.", "puntuacion": -1 }, { "respuesta": "Le preguntarías: 'Entiendo que se sienta así. ¿Qué cree que necesitaría para que esto le resulte un poco menos desafiante o para que lo intente de otra manera?'", "puntuacion": 1 }, { "respuesta": "Le dirías: 'Sí, a veces las cosas son difíciles, pero debe esforzarse'.", "puntuacion": -1 }] }, { "id": 3, "pregunta": "Tienes un compromiso personal importante, pero el adulto mayor te pide que hagas una diligencia urgente que te tomaría todo el tiempo. ¿Cómo manejarías la situación?", "opciones": [{ "respuesta": "Cancelarías tu compromiso personal, porque el adulto mayor es tu prioridad.", "puntuacion": -1 }, { "respuesta": "Le dirías que no puedes ir y que debe buscar a otra persona o esperar.", "puntuacion": -1 }, { "respuesta": "Con respeto, le explicarías que tienes un compromiso importante que no puedes cambiar, y le ayudarías a buscar otra solución o momento para la diligencia.", "puntuacion": 1 }, { "respuesta": "Harías la diligencia de mala gana y luego te quejarías con tus amigos sobre lo exigente que es.", "puntuacion": -1 }] }, { "id": 4, "pregunta": "Un adulto mayor, que está postrado en cama, te comenta: 'Mi vida ya no tiene sentido, no puedo hacer nada de lo que me gustaba'. ¿Cómo lo guiarías?", "opciones": [{ "respuesta": "Le dirías: 'Claro que sí, ¡hay muchas cosas que aún puede hacer!'.", "puntuacion": -1 }, { "respuesta": "Lo animarías a enfocarse en sus recuerdos felices para que se sienta mal.", "puntuacion": -1 }, { "respuesta": "Le preguntarías: 'A pesar de sus limitaciones físicas, ¿qué cosas dentro de usted, como sus pensamientos, sus ideas, su actitud o sus afectos, aún puede elegir y controlar para darle un nuevo sentido a su día a día?'", "puntuacion": 1 }, { "respuesta": "Le sugerirías que vea más televisión o escuche música para distraerse y no pensar en ello.", "puntuacion": -1 }] }, { "id": 5, "pregunta": "Estás a punto de iniciar el acompañamiento con un adulto mayor. ¿Qué te parece lo más importante establecer en su primera conversación?", "opciones": [{ "respuesta": "Una lista detallada de todas las prohibiciones y lo que el adulto mayor no debe hacer.", "puntuacion": -1 }, { "respuesta": "Asegurarle que este es un espacio completamente seguro, donde puede expresarse libremente, sin que haya juicios o críticas sobre lo que diga o sienta.", "puntuacion": 1 }, { "respuesta": "Explicarle que no eres un juez y que no te importa lo que haya hecho en el pasado.", "puntuacion": -1 }, { "respuesta": "Definir quién tiene el control y la última palabra en las decisiones diarias.", "puntuacion": -1 }] }, { "id": 6, "pregunta": "Un familiar del adulto mayor tiene una idea muy diferente a la tuya sobre cómo ayudarlo, y la discusión se vuelve tensa. ¿Cómo buscarías resolver esta diferencia?", "opciones": [{ "respuesta": "Intentarías convencerlos de que tu idea es la 'buena' y la suya es la 'mala'.", "puntuacion": -1 }, { "respuesta": "Te enfocarías en entender qué es lo más importante para cada uno (sus 'intereses'), más allá de la idea específica que están defendiendo, para encontrar una solución que beneficie a todos.", "puntuacion": 1 }, { "respuesta": "Pondrías fin a la discusión y harías lo que consideres 'correcto' sin su opinión.", "puntuacion": -1 }, { "respuesta": "Dejarías que el familiar tome la decisión para evitar el conflicto, incluso si no estás de acuerdo.", "puntuacion": -1 }] }, { "id": 7, "pregunta": "Si el adulto mayor te pide realizar una tarea que sabes que podría hacer por sí mismo con un poco de guía, ¿qué harías, teniendo en cuenta la idea de fomentar su autonomía?", "opciones": [{ "respuesta": "Lo harías por él para ahorrar tiempo y evitar que se frustre.", "puntuacion": -1 }, { "respuesta": "Le dirías 'no, usted puede hacerlo solo' sin más explicaciones.", "puntuacion": -1 }, { "respuesta": "Le preguntarías: '¿Qué parte de la tarea se le hace más compleja o dónde siente que necesita un apoyo para que usted pueda hacerlo?'", "puntuacion": 1 }, { "respuesta": "Le dirías que si no lo hace, no podrás seguir ayudándole en otras cosas.", "puntuacion": -1 }] }, { "id": 8, "pregunta": "Imagina que el adulto mayor está pasando por un momento de gran tristeza y te dice: 'No sé para qué sigo aquí, ya no encuentro ningún sentido a mi vida'. ¿Cuál sería tu enfoque para ayudarle?", "opciones": [{ "respuesta": "Le dirías que no se preocupe, que la tristeza pasará pronto y que debe ser fuerte.", "puntuacion": -1 }, { "respuesta": "Le ayudarías a recordar momentos felices del pasado para que se sienta mejor.", "puntuacion": -1 }, { "respuesta": "Le escucharías activamente, validando su sentimiento, y luego le preguntarías si hay algo, por pequeño que sea, que aún le dé una chispa de interés o una razón para continuar.", "puntuacion": 1 }, { "respuesta": "Le sugerirías visitar a un familiar o amigo para que lo animen.", "puntuacion": -1 }] }, { "id": 9, "pregunta": "Tienes un plan de actividades bien organizado para el adulto mayor, pero un día él se siente mal anímicamente y no quiere hacer nada. ¿Cómo adaptarías tu 'proyecto' de ese día?", "opciones": [{ "respuesta": "Insistirías en seguir el plan, porque la estructura es importante para la disciplina.", "puntuacion": -1 }, { "respuesta": "Cancelarías todas las actividades y te irías, ya que no se puede trabajar así.", "puntuacion": -1 }, { "respuesta": "Buscarías entender qué le sucede y adaptarías el plan a su estado anímico, quizás posponiendo algunas cosas o cambiando a actividades más tranquilas y reconfortantes.", "puntuacion": 1 }, { "respuesta": "Le dirías que está 'mal' no querer hacer nada y que debe esforzarse para seguir el plan.", "puntuacion": -1 }] }, { "id": 10, "pregunta": "Finalmente, si tu propósito general en la vida fuera 'ayudar a las personas a encontrar su propia felicidad y bienestar', ¿cómo se vería eso reflejado en tu día a día como acompañante de un adulto mayor?", "opciones": [{ "respuesta": "Me enfocaría en hacer todo por el adulto mayor para que no tenga preocupaciones.", "puntuacion": -1 }, { "respuesta": "Priorizaría su seguridad y comodidad, sin preocuparme mucho por su estado emocional o sus metas personales a largo plazo.", "puntuacion": -1 }, { "respuesta": "Ayudaría al adulto mayor a identificar lo que le hace feliz, lo que le da propósito, y lo apoyaría en pequeños proyectos o actividades que le permitan vivir con más plenitud, siempre cuidando mi propio bienestar.", "puntuacion": 1 }, { "respuesta": "Les daría consejos y les diría lo que deben hacer para ser felices.", "puntuacion": -1 }] }]
        };

        const baremo = [{ "rango_puntuacion": [7, 10], "evaluacion": "Apto", "mensaje": "Gracias por completar la prueba. Hemos registrado tus respuestas y nos pondremos en contacto contigo pronto para los siguientes pasos." }, { "rango_puntuacion": [3, 6], "evaluacion": "Apto con reservas", "mensaje": "Gracias por completar la prueba. Hemos registrado tus respuestas y tu postulación será revisada por nuestro equipo." }, { "rango_puntuacion": [-10, 2], "evaluacion": "No apto", "mensaje": "Agradecemos tu interés en formar parte de T-Asisto. En esta ocasión, tu perfil no se ajusta completamente a los requisitos del puesto. Te deseamos mucho éxito en tu búsqueda." }];

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                     if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid;
                }
                console.log("Usuario autenticado. UID:", userId);
            });
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
        }

        const form = document.getElementById('psychometricTestForm');
        const testContainer = document.getElementById('testContainer');
        const resultContainer = document.getElementById('resultContainer');
        const finalMessageEl = document.getElementById('finalMessage');
        
        function loadQuestions() {
            let questionsHTML = '';
            testData.preguntas.forEach((q) => {
                questionsHTML += `
                    <div class="question-card bg-gray-50 p-6 rounded-lg">
                        <p class="font-semibold text-gray-800 mb-4">${q.id}. ${q.pregunta}</p>
                        <div class="space-y-3">
                `;
                q.opciones.forEach((opt) => {
                    questionsHTML += `
                        <label class="p-4 rounded-lg border border-gray-300 hover:bg-indigo-50 cursor-pointer transition-all duration-200 block">
                            <input type="radio" name="q${q.id}" value="${opt.puntuacion}" class="sr-only" required>
                            <span class="font-medium text-gray-700">${opt.respuesta}</span>
                        </label>
                    `;
                });
                questionsHTML += `</div></div>`;
            });
             questionsHTML += `
                <div class="flex justify-end pt-4">
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300">
                        Finalizar Prueba
                    </button>
                </div>`;
            form.innerHTML = questionsHTML;
        }
        
        loadQuestions();

        form.addEventListener('change', (e) => {
            if (e.target.type === 'radio') {
                const questionName = e.target.name;
                document.querySelectorAll(`input[name="${questionName}"]`).forEach(radio => {
                    const label = radio.parentElement;
                    label.classList.remove('border-indigo-600', 'bg-indigo-50', 'ring-2', 'ring-indigo-500');
                    label.classList.add('border-gray-300');
                });
                const selectedLabel = e.target.parentElement;
                selectedLabel.classList.remove('border-gray-300');
                selectedLabel.classList.add('border-indigo-600', 'bg-indigo-50', 'ring-2', 'ring-indigo-500');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) {
                console.error("No hay un usuario autenticado para guardar los datos.");
                alert("Error de autenticación. Por favor, recargue la página.");
                return;
            }

            const formData = new FormData(form);
            const answers = {};
            let totalScore = 0;
            
            for (const [key, value] of formData.entries()) {
                answers[key] = value;
                totalScore += parseInt(value, 10);
            }
            
            let resultEvaluation = "No evaluado";
            let finalMessage = "Error al procesar el resultado.";

            for (const level of baremo) {
                const [min, max] = level.rango_puntuacion;
                if (totalScore >= min && totalScore <= max) {
                    resultEvaluation = level.evaluacion;
                    finalMessage = level.mensaje;
                    break;
                }
            }
            
            const finalResults = {
                answers,
                score: totalScore,
                evaluation: resultEvaluation,
                submissionTimestamp: new Date()
            };

            console.log("Guardando resultados finales:", finalResults);
            
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/psychometric_tests`;
                const docRef = await addDoc(collection(db, collectionPath), finalResults);
                console.log("Resultados guardados con ID: ", docRef.id);
                
                testContainer.classList.add('hidden');
                finalMessageEl.textContent = finalMessage;
                if (resultEvaluation === "No apto") {
                    finalMessageEl.className = 'p-4 rounded-lg bg-yellow-100 border border-yellow-400 text-yellow-700';
                } else {
                    finalMessageEl.className = 'p-4 rounded-lg bg-green-100 border border-green-400 text-green-700';
                }
                resultContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error al guardar los resultados: ", error);
                alert("Hubo un error al guardar tus respuestas. Por favor, inténtalo de nuevo.");
            }
        });
    </script>
</body>
</html>

